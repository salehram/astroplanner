{% extends "base.html" %}
{% block content %}

<style>
  .subexp-input {
    width: 90px !important;
    min-width: 90px !important;
  }
  .minutes-input {
    width: 90px !important;
    min-width: 90px !important;
  }

  /* Allow header text in the plan table to wrap to 2 lines */
  #plan-table th {
    white-space: normal;
    vertical-align: middle;
  }
</style>

<!-- HEADER -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h1 class="h3 mb-0">{{ target.name }}</h1>
    <div class="text-light small">
      {{ target.catalog_id or "No catalog ID" }} •
      {{ target.target_type or "Type N/A" }} •
      RA {{ "%.3f"|format(target.ra_hours) }}h,
      Dec {{ "%.2f"|format(target.dec_deg) }}°
      {% if target_created_local %}
        • <span class="text-warning">
            Created {{ target_created_local.strftime("%Y-%m-%d %H:%M:%S") }}
          </span>
      {% endif %}
    </div>
  </div>
  <div class="d-flex gap-2">
    <a href="{{ url_for('edit_target', target_id=target.id) }}"
       class="btn btn-outline-light btn-sm">Edit</a>
    <a href="{{ url_for('target_settings', target_id=target.id) }}"
       class="btn btn-outline-info btn-sm">Settings</a>
    <form method="post"
          action="{{ url_for('delete_target', target_id=target.id) }}"
          onsubmit="return confirm('Delete target {{ target.name }} and all its data?');">
      <button class="btn btn-outline-danger btn-sm" type="submit">Delete</button>
    </form>
  </div>
</div>

<!-- ROW 1: PLAN & PALETTE (FULL WIDTH) -->
<div class="row g-4 mb-4">
  <div class="col-12">
    <div class="card bg-secondary text-light">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>Plan & Palette</span>
        <form method="post" action="{{ url_for('new_plan', target_id=target.id) }}"
              class="d-flex gap-2">
          <select name="palette" class="form-select form-select-sm">
            {% for palette in palettes %}
              <option value="{{ palette.name }}" {% if palette.name==target.preferred_palette %}selected{% endif %}>
                {{ palette.display_name }}
              </option>
            {% endfor %}
          </select>
          <button class="btn btn-sm btn-outline-light" type="submit">New Plan</button>
        </form>
      </div>

      <div class="card-body">
        {% if plan_data %}

          <p class="mb-1"><strong>Palette:</strong> {{ plan_data.palette }}</p>
          <p class="mb-2"><strong>Dominant Channel:</strong> {{ plan_data.dominant_channel }}</p>

          <form method="post" action="{{ url_for('update_plan', target_id=target.id) }}" id="plan-form">

            <div class="row mb-3">
              <div class="col-md-4 mb-2">
                <label class="form-label">Total Planned Time</label>
                <div class="input-group input-group-sm">
                  <input id="total_planned_minutes" class="form-control"
                         type="number" step="1" min="0"
                         name="total_planned_minutes"
                         value="{{ plan_data.total_planned_minutes }}"
                         placeholder="Minutes">
                  <span class="input-group-text">min</span>
                </div>
                <input id="total_planned_hms" class="form-control form-control-sm mt-1"
                       type="text" placeholder="H:M:S format (e.g. 6:00:00)"
                       title="Enter time in H:M:S format">
              </div>

              <div class="col-md-4 mb-2">
                <label class="form-label">Fallback Sub-exposure (s)</label>
                <input id="plan_sub_exposure" class="form-control form-control-sm"
                       type="number" min="1" step="1" value="300">
              </div>
            </div>

            <!-- MAIN WIDE TABLE -->
            <div class="table-responsive" style="padding-bottom: 12px;">
              <table id="plan-table"
                     class="table table-sm table-dark align-middle mb-0"
                     data-tonight-minutes="{{ window_info.total_minutes or 0 }}">

                <thead>
                  <tr>
                    <th>Channel</th>
                    <th>Label</th>
                    <th>Planned (mins)</th>
                    <th>Planned (h:m:s)</th>
                    <th>Sub (s)</th>
                    <th>Completed Time</th>
                    <th>Planned Frames</th>
                    <th>Done Frames</th>
                    <th>Remaining Frames</th>
                    <th>Remaining Time</th>
                    <th>Remaining (h:m:s)</th>
                    <th>Status</th>
                  </tr>
                </thead>

                <tbody>
                  {% for ch in plan_data.channels %}
                    {% set done = progress_minutes.get(ch.name, 0) %}
                    {% set done_sec = progress_seconds.get(ch.name, 0) %}
                    <tr class="plan-row">
                      <td>{{ ch.name }}</td>
                      <td>{{ ch.label }}</td>

                      <!-- Planned minutes (editable) -->
                      <td>
                        <input class="form-control form-control-sm channel-minutes minutes-input"
                              type="number" step="1" min="0"
                              name="ch_{{ ch.name }}_minutes"
                              value="{{ ch.planned_minutes }}"
                              title="Minutes">
                      </td>

                      <!-- Planned H:M:S (editable) -->
                      <td>
                        <input class="form-control form-control-sm channel-hms hms-input"
                              type="text" placeholder="H:M:S"
                              title="H:M:S format (e.g. 3:00:00)">
                      </td>

                      <!-- Sub-exposure -->
                      <td>
                        <input class="form-control form-control-sm channel-subexp subexp-input"
                              type="number" step="1" min="1"
                              name="ch_{{ ch.name }}_subexp"
                              value="{{ ch.sub_exposure_seconds or 300 }}">
                      </td>

                      <!-- Completed minutes -->
                      <td class="completed-minutes"
                          data-done-seconds="{{ done_sec|default(0) }}">
                        {{ "%.1f"|format(done) }}
                      </td>

                      <!-- Planned frames (editable – drives minutes if you change it) -->
                      <td>
                        <input class="form-control form-control-sm planned-frames-input"
                              type="number" step="1" min="0"
                              value="">
                      </td>

                      <!-- Done / remaining -->
                      <td class="done-frames">-</td>
                      <td class="remaining-frames fw-bold">-</td>
                      <td class="remaining-minutes fw-bold">-</td>
                      <td class="remaining-hms fw-bold">-</td>
                      <td class="status-badge"></td>
                    </tr>
                  {% endfor %}
                </tbody>

              </table>
            </div>

            <button class="btn btn-outline-light btn-sm mt-3" type="submit">
              Save Plan
            </button>

            <button class="btn btn-outline-info btn-sm mt-3"
                    formaction="{{ url_for('export_nina_sequence', target_id=target.id) }}"
                    formmethod="post">
              Export NINA Sequence (remaining subs)
            </button>

          </form>
        {% else %}
          <p>No plan yet. Create one above.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- ROW 2: TONIGHT'S WINDOW (LEFT) + RIGHT COLUMN STACK (PROGRESS + NOTES + PIXINSIGHT) -->
<div class="row g-4 mb-4">
  <!-- TONIGHT -->
  <div class="col-lg-6">
    <div class="card bg-secondary text-light h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>Tonight's Window</span>
        <small class="text-muted">
          Local TZ:
          <span title="Taken from OBSERVER_TZ environment variable">
            {{ window_info.timezone_name or "Unknown" }}
          </span>
        </small>
      </div>

      <div class="card-body">
        {% if window_info.deps_available %}
          <p class="mb-1">
            <strong>Sunset (local):</strong> {{ window_info.sunset_local }}
            <span class="text-warning small">[UTC: {{ window_info.sunset_utc }}]</span>
          </p>

          <p class="mb-1">
            <strong>Dark Start (local):</strong> {{ window_info.dark_start_local }}
            <span class="text-warning small">[UTC: {{ window_info.dark_start_utc }}]</span>
          </p>

          <p class="mb-1">
            <strong>Dark End (local):</strong> {{ window_info.dark_end_local }}
            <span class="text-warning small">[UTC: {{ window_info.dark_end_utc }}]</span>
          </p>

          <p class="mb-1">
            <strong>Meridian Transit (local):</strong> {{ window_info.meridian_local }}
            <span class="text-warning small">[UTC: {{ window_info.meridian_utc }}]</span>
          </p>

          <hr class="my-2">

          <p class="mb-1">
            <strong>Effective Start (local):</strong> {{ window_info.start_time_local }}
            <span class="text-warning small">[UTC: {{ window_info.start_time_utc }}]</span>
          </p>

          <p class="mb-1">
            <strong>Effective End (local):</strong> {{ window_info.end_time_local }}
            <span class="text-warning small">[UTC: {{ window_info.end_time_utc }}]</span>
          </p>

          <p class="mb-1">
            <strong>Total Window:</strong>
            {% if window_info.total_minutes is not none %}
              {{ window_info.total_minutes|format_hms_from_minutes }} ({{ window_info.total_minutes }} minutes)
            {% else %}
              N/A
            {% endif %}
          </p>

          <p class="mb-1 small text-muted">
            Altitude threshold used: ≥ {{ window_info.min_altitude_deg }}° •
            Mid-window altitude:
            {% if window_info.midpoint_altitude_deg is not none %}
              {{ window_info.midpoint_altitude_deg }}°
            {% else %}
              N/A
            {% endif %}
          </p>

          <!-- Why this window is this long -->
          <div class="mt-2 small text-muted">
            <strong>Why is this window {{ window_info.total_minutes }} min?</strong><br>
            • Nautical night (local): {{ window_info.dark_start_local }} → {{ window_info.dark_end_local }}<br>
            • Pack-up time (local clock): {{ target.packup_time_local or "none (using full dark)" }}<br>
            • Base dark+packup window:
              {{ window_info.raw_start_local }} → {{ window_info.raw_end_local }}
              ({{ window_info.raw_total_minutes }} min)<br>
            • Applying altitude ≥ {{ window_info.min_altitude_deg }}° gives:
              {{ window_info.start_time_local }} → {{ window_info.end_time_local }}
              ({{ window_info.total_minutes }} min).
          </div>

          <!-- Altitude chart -->
          {% if window_info.altitude_profile and window_info.altitude_profile|length > 0 %}
            <hr class="my-3">
            <h6 class="small text-uppercase text-muted mb-1">Altitude over night</h6>
            <canvas id="altitudeChart" height="160"></canvas>
          {% endif %}

        {% else %}
          <p>{{ window_info.note }}</p>
          <p>Install astropy + astroplan for full functionality.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- RIGHT COLUMN STACK: PROGRESS + NOTES + PIXINSIGHT -->
  <div class="col-lg-6 d-flex flex-column gap-4">
    <!-- ADD IMAGING PROGRESS -->
    <div class="card bg-secondary text-light">
      <div class="card-header">Add Imaging Progress</div>
      <div class="card-body">
        <form method="post" action="{{ url_for('add_progress', target_id=target.id) }}">
          <div class="row">
            <div class="col-md-4 mb-2">
              <label class="form-label">Channel</label>
              <input class="form-control" name="channel"
                     placeholder="H, O, S, L, R, G, B" required>
            </div>

            <div class="col-md-4 mb-2">
              <label class="form-label">Sub Exposure (s)</label>
              <input class="form-control" name="sub_exposure_seconds"
                     type="number" value="300" required>
            </div>

            <div class="col-md-4 mb-2">
              <label class="form-label">Sub Count</label>
              <input class="form-control" name="sub_count"
                     type="number" value="10" required>
            </div>
          </div>

          <div class="mb-2">
            <label class="form-label">Notes (optional)</label>
            <input class="form-control" name="notes">
          </div>

          <button class="btn btn-primary btn-sm" type="submit">Add Progress</button>
        </form>
      </div>
    </div>

    <!-- NOTES -->
    <div class="card bg-secondary text-light">
      <div class="card-header">Notes</div>
      <div class="card-body">
        {% if target.notes %}
          <pre class="mb-0" style="white-space: pre-wrap;">{{ target.notes }}</pre>
        {% else %}
          <p class="text-muted mb-0">No notes yet.</p>
        {% endif %}
      </div>
    </div>

    <!-- PIXINSIGHT WORKFLOW -->
    <div class="card bg-secondary text-light">
      <div class="card-header">PixInsight Workflow</div>
      <div class="card-body">
        {% if target.pixinsight_workflow %}
          <pre class="mb-0" style="white-space: pre-wrap;">{{ target.pixinsight_workflow }}</pre>
        {% else %}
          <p class="text-muted mb-0">No workflow documented yet.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- ROW: FINAL IMAGE -->
<div class="row g-4">
  <div class="col-12">
    <div class="card bg-secondary text-light">
      <div class="card-header">Final Image</div>

      <div class="card-body">
        {% if target.final_image_filename %}
          <div class="mb-2">
            <img src="{{ url_for('uploaded_file', filename=target.final_image_filename) }}"
                 class="img-fluid rounded border border-light">
          </div>
          <p class="text-muted small">Saved as {{ target.final_image_filename }}</p>
        {% else %}
          <p class="text-muted">No final image uploaded yet.</p>
        {% endif %}

        <hr>

        <form method="post" enctype="multipart/form-data"
              action="{{ url_for('upload_final_image', target_id=target.id) }}">
          <div class="mb-2">
            <label class="form-label">Upload final processed image</label>
            <input class="form-control" type="file" name="final_image" accept="image/*">
          </div>
          <button class="btn btn-outline-light btn-sm" type="submit">Upload / Replace</button>
        </form>
      </div>

    </div>
  </div>
</div>

<!-- Chart.js for altitude plot -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- JS: Progress calculations + status badges + altitude chart -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const globalExpInput = document.getElementById("plan_sub_exposure");
  const planTable = document.getElementById("plan-table");
  const rows = document.querySelectorAll("tr.plan-row");

  const tonightWindowMinutes = planTable
    ? parseFloat(planTable.dataset.tonightMinutes || "0") || 0
    : 0;

  function formatHMS(totalSeconds) {
    totalSeconds = Math.max(0, Math.floor(totalSeconds));
    const h = Math.floor(totalSeconds / 3600);
    const m = Math.floor((totalSeconds % 3600) / 60);
    const s = totalSeconds % 60;
    return String(h).padStart(2,"0") + ":" +
           String(m).padStart(2,"0") + ":" +
           String(s).padStart(2,"0");
  }

  function recalcFrames() {
    if (!planTable) return;

    const globalExp = globalExpInput
      ? parseFloat(globalExpInput.value)
      : NaN;

    rows.forEach(row => {
      const minInput = row.querySelector("input.channel-minutes");
      const hmsInput = row.querySelector("input.channel-hms");
      const subInput = row.querySelector("input.channel-subexp");
      const doneCell = row.querySelector("td.completed-minutes");
      const framesInput = row.querySelector("input.planned-frames-input");

      const df = row.querySelector(".done-frames");
      const rf = row.querySelector(".remaining-frames");
      const rm = row.querySelector(".remaining-minutes");
      const rh = row.querySelector(".remaining-hms");
      const sb = row.querySelector(".status-badge");

      if (!minInput || !subInput || !doneCell) return;

      // Handle bidirectional minutes <-> H:M:S conversion for channels
      if (hmsInput) {
        const active = document.activeElement;
        
        if (active === hmsInput) {
          // User is editing HMS: update minutes
          const seconds = parseHMS(hmsInput.value);
          if (seconds !== null) {
            const minutes = seconds / 60;
            minInput.value = minutes.toFixed(1);
          }
        } else if (active === minInput || !hmsInput.value) {
          // User is editing minutes or HMS is empty: update HMS
          const minutes = parseFloat(minInput.value);
          if (!isNaN(minutes) && minutes >= 0) {
            hmsInput.value = minutesToHMS(minutes);
          }
        }
      }

      // Base values
      let mins = parseFloat(minInput.value);
      if (isNaN(mins) || mins < 0) mins = 0;

      let exp = parseFloat(subInput.value);
      if (isNaN(exp) || exp <= 0) exp = globalExp;
      if (isNaN(exp) || exp <= 0) exp = 300;  // last-resort fallback

      // Sync minutes <-> planned frames
      if (framesInput) {
        const active = document.activeElement;
        let framesVal = parseFloat(framesInput.value);

        if (active === framesInput && !isNaN(framesVal) && framesVal >= 0) {
          // User is editing frames: drive minutes from frames
          mins = (framesVal * exp) / 60.0;
          minInput.value = mins.toFixed(1);
          // Also update H:M:S field
          if (hmsInput) {
            hmsInput.value = minutesToHMS(mins);
          }
        } else {
          // User is editing minutes / subexposure / global exp:
          // recompute frames from minutes
          if (mins > 0 && exp > 0) {
            framesVal = Math.ceil((mins * 60.0) / exp);
          } else {
            framesVal = 0;
          }
          framesInput.value = framesVal > 0 ? framesVal : "";
          
          // Also update H:M:S field when not the active element
          if (hmsInput && active !== hmsInput && mins >= 0) {
            hmsInput.value = minutesToHMS(mins);
          }
        }
      }

      // Remaining time
      const plannedSeconds = Math.max(mins * 60.0, 0);
      const doneSec = parseFloat(doneCell.dataset.doneSeconds || "0");
      const remainingSec = Math.max(plannedSeconds - doneSec, 0);

      rm.textContent = (remainingSec / 60).toFixed(1);
      rh.textContent = formatHMS(remainingSec);

      // Status badge
      const remMin = remainingSec / 60;
      let badge = "";

      if (remainingSec <= 0) {
        badge = '<span class="badge bg-secondary">Done</span>';
      } else if (tonightWindowMinutes <= 0) {
        badge = '<span class="badge bg-secondary">No window</span>';
      } else if (remMin <= tonightWindowMinutes * 0.8) {
        badge = '<span class="badge bg-success">Finishable tonight</span>';
      } else if (remMin <= tonightWindowMinutes * 2) {
        badge = '<span class="badge bg-warning text-dark">Good progress</span>';
      } else {
        badge = '<span class="badge bg-dark">Long-term</span>';
      }
      sb.innerHTML = badge;

      // Frame math (for done + remaining frames display)
      let plannedFrames = 0;
      let doneFrames = 0;
      let remainingFrames = 0;

      if (exp > 0) {
        plannedFrames = Math.ceil(plannedSeconds / exp);
        doneFrames = Math.floor(doneSec / exp);
        remainingFrames = Math.max(plannedFrames - doneFrames, 0);
      }

      if (df) df.textContent = doneFrames;
      if (rf) rf.textContent = remainingFrames;
    });
  }

  // H:M:S parsing and formatting utilities
  function parseHMS(hmsString) {
    if (!hmsString || !hmsString.trim()) return null;
    
    const str = hmsString.trim();
    
    // Try H:M:S or H:M format
    if (str.includes(':')) {
      const parts = str.split(':').map(p => parseInt(p));
      if (parts.length === 2 && !parts.some(isNaN)) {
        return parts[0] * 3600 + parts[1] * 60; // H:M
      } else if (parts.length === 3 && !parts.some(isNaN)) {
        return parts[0] * 3600 + parts[1] * 60 + parts[2]; // H:M:S
      }
    }
    
    // Try as decimal (treat as hours if <= 24, otherwise minutes)
    const value = parseFloat(str);
    if (!isNaN(value)) {
      return value <= 24 ? value * 3600 : value * 60;
    }
    
    return null;
  }
  
  function minutesToHMS(minutes) {
    const totalSeconds = Math.max(0, Math.floor(minutes * 60));
    const h = Math.floor(totalSeconds / 3600);
    const m = Math.floor((totalSeconds % 3600) / 60);
    const s = totalSeconds % 60;
    return h + ":" + String(m).padStart(2, "0") + ":" + String(s).padStart(2, "0");
  }

  // Setup bidirectional total planned time conversion
  function setupTotalTimeConversion() {
    const minutesInput = document.getElementById("total_planned_minutes");
    const hmsInput = document.getElementById("total_planned_hms");
    
    if (!minutesInput || !hmsInput) return;
    
    // Initialize HMS input with current minutes value
    if (minutesInput.value) {
      hmsInput.value = minutesToHMS(parseFloat(minutesInput.value));
    }
    
    // Minutes input changes -> update HMS
    minutesInput.addEventListener("input", function() {
      const minutes = parseFloat(this.value);
      if (!isNaN(minutes) && minutes >= 0) {
        hmsInput.value = minutesToHMS(minutes);
      }
    });
    
    // HMS input changes -> update minutes
    hmsInput.addEventListener("input", function() {
      const seconds = parseHMS(this.value);
      if (seconds !== null) {
        const minutes = seconds / 60;
        minutesInput.value = minutes.toFixed(1);
        // Trigger recalc to update the plan
        recalcFrames();
      }
    });
  }

  // Setup everything
  setupTotalTimeConversion();
  
  // Initialize channel H:M:S inputs
  rows.forEach(row => {
    const minInput = row.querySelector("input.channel-minutes");
    const hmsInput = row.querySelector("input.channel-hms");
    
    if (minInput && hmsInput && minInput.value) {
      hmsInput.value = minutesToHMS(parseFloat(minInput.value));
    }
  });


  if (globalExpInput && planTable) {
    globalExpInput.addEventListener("input", recalcFrames);
    rows.forEach(row => {
      row.querySelectorAll("input").forEach(input => {
        input.addEventListener("input", recalcFrames);
      });
    });
    recalcFrames();
  }

  setupAltitudeChart();

  function setupAltitudeChart() {
    const canvas = document.getElementById("altitudeChart");
    if (!canvas) return;

    const altitudeData = {{ window_info.altitude_profile|tojson|safe }};
    if (!altitudeData || !altitudeData.length) return;

    const ctx = canvas.getContext("2d");
    new Chart(ctx, {
      type: "line",
      data: {
        labels: altitudeData.map(p => p.time_label),
        datasets: [{
          label: "Altitude (°)",
          data: altitudeData.map(p => p.alt_deg),
          tension: 0.25,
          borderWidth: 2,
          pointRadius: 0
        }]
      },
      options: {
        scales: {
          y: {
            title: {
              display: true,
              text: "Altitude (°)"
            },
            suggestedMin: 0,
            suggestedMax: 90
          },
          x: {
            title: {
              display: true,
              text: "Local Time"
            }
          }
        },
        plugins: {
          legend: { display: false }
        }
      }
    });
  }
});
</script>

{% endblock %}
